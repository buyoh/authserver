<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/auth-portal/assets/style.css">
  <script src="/auth-portal/assets/api.js"></script>
  <title>user</title>
  <style>
    body {
      font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
    }
  </style>
</head>

<body>
  <div class="pagewrapper">
    <div class="content page ">
      <h1>user page</h1>
      <section>
        <h2>Logout</h2>
        <form onsubmit="handleEvent_logout(event)">
          <button class="large special" type="submit">logout</button>
        </form>
      </section>
      <section>
        <h2>management accounts</h2>
        <div>
          <table id="userlist_table">
            <tr>
              <th>username</th>
              <th>auth-level</th>
              <th></th>
            </tr>
          </table>
        </div>
        <form id="form-accounts">
          <div><output class="highlight" name="log"></output></div>
        </form>
      </section>
      <section>
        <h2>add a new user account</h2>
        <form id="form-adduser" onsubmit="handleEvent_adduser_submit(event)">
          <input type="text" name="user" spellcheck="false" required="true" placeholder="username" minlength="2"
            autocomplete="off" autocapitalize="off">
          <select name="level">
            <option value="21" selected>member</option>
            <option value="11">manager</option>
          </select>
          <select name="crypto">
            <option value="pass" selected>pass</option>
            <option value="otpauth">otpauth</option>
            <option value="nopass">nopass</option>
          </select>
          <!-- TODO: Hide this input when otpauth or nopass is selected -->
          <input type="password" name="pass" spellcheck="false" placeholder="pass/salt" minlength="2" autocomplete="off"
            autocapitalize="off">
          <button type="submit">adduser</button>
          <pre><output class="highlight" name="log"></output></pre>
        </form>
      </section>
    </div>
  </div>

  <script>
    async function handleEvent_logout(event) {
      await fetchLogout();
      location.reload();
    }
    async function handleEvent_adduser_submit(event) {
      event.preventDefault();
      const form = document.getElementById('form-adduser');
      const username = form.user.value;
      const level = parseInt(form.level.value);
      const crypto = form.crypto.value;
      const pass = form.pass.value;

      const [ok, res] = await addUser(username, level, crypto, pass);
      // if (ok)
      form.log.value = res;
    }

    async function addUser(username, level, crypto, pass) {
      if (username.length < 3)
        return [false, 'invalid arguments: username.length < 3'];
      const res = await fetchAddUser(username, level, crypto, pass);
      if (!res.ok) {
        console.warn('fetch failed', res.status);
        return [false, 'fetch failed: '];
      }
      const { ok, data, error } = await res.json();
      if (!ok) {
        console.warn('server error');
        return [false, 'server error' + JSON.stringify(error)];
      }
      const resOtpauth = data.otpauth;  // TODO: 
      updateUserList();
      return [true, JSON.stringify(resOtpauth)];
    }

    async function deleteUser(username) {
      const form = document.getElementById('form-accounts');
      const res = await fetchDeleteUser(username);
      if (!res.ok) {
        form.log.value = 'fetch failed: ' + res.status;
        console.warn('fetch failed', res.status);
        return;
      }
      updateUserList();
    }

    function createUserRow(user, me) {
      const tdName = document.createElement('td');
      const tdLevel = document.createElement('td');
      const tdActs = document.createElement('td');
      tdName.appendChild(document.createTextNode(user.username));
      tdLevel.appendChild(document.createTextNode(authLevelToString(user.level)));
      if (user.me)
        tdActs.appendChild(document.createTextNode('[you]'));
      else {
        const delbtn = document.createElement('input');
        delbtn.value = 'delete';
        delbtn.type = 'button';
        delbtn.disabled = me.level !== 1 && user.level < me.level;
        delbtn.addEventListener('click', () => { deleteUser(user.username); });
        tdActs.appendChild(delbtn);
      }
      const tr = document.createElement('tr');
      tr.classList.add('user');
      tr.append(tdName, tdLevel, tdActs);
      return tr;
    }

    async function updateUserList() {
      const form = document.getElementById('form-accounts');
      const res = await fetchGetAllUser();
      if (!res.ok) {
        form.log.value = 'fetch failed: ' + res.status;
        return;
      }
      const json = await res.json();
      if (!json.ok || (typeof json.data) != 'object') {
        form.log.value = 'data invalid';
        console.warn('data failed', json);
        return;
      }
      document.querySelectorAll('#userlist_table .user').forEach(e => e.remove());
      const me = json.data.find(u => u.me);
      for (const user of json.data) {
        document.getElementById('userlist_table').append(createUserRow(user, me));
      }
      form.log.value = 'updated.';
    }
    document.addEventListener('DOMContentLoaded', () => {
      updateUserList();
    });
  </script>
</body>

</html>