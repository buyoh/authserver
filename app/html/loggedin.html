<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    body {
      font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
    }
  </style>
</head>

<body>
  <p>
    You are already logged in.
  </p>
  <hr>
  <form action="/auth-portal/logout" method="POST">
    <button type="submit">logout</button>
  </form>
  <hr>
  <p>add a new user account</p>
  <form method="POST" onsubmit="handleEvent_adduser_submit(event)">
    <input type="text" name="user" id="adduser_user" spellcheck="false" required="true" placeholder="username"
      minlength="2" autocomplete="off" autocapitalize="off">
    <button type="submit">adduser</button>
    <pre><output id="adduser_log"></output></pre>
  </form>
  <hr>
  <p>user account list</p>
  <div>
    <table id="userlist_table" border="1">
      <tr>
        <th>username</th>
        <th>auth-level</th>
        <th></th>
      </tr>
    </table>
  </div>

  <script>
    function myfetch(uri, method, json) {
      const headers = {
        'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
      };
      const body = Object.entries(json).map((kv) =>
        kv[0] + "=" + encodeURIComponent(kv[1])).join('&');
      return fetch(uri, { method, body, headers });
    }

    function handleEvent_adduser_submit(event) {
      event.preventDefault();
      const username = document.getElementById('adduser_user').value;
      const level = 21;
      if (username.length < 3)
        return;
      myfetch('/auth-portal/user', 'POST', { username, level }).then(async (res) => {
        if (!res.ok) {
          console.warn('fetch failed', res.status);
          return;
        }
        const { ok, data } = await res.json();
        if (!ok) {
          console.warn('ng');
          return;
        }
        const resUsername = data.username;
        const resLevel = data.level;
        const resOtpauth = data.otpauth;
        // TODO: validate
        document.getElementById('adduser_log').value = resOtpauth;
        updateUserList();
      });
    }

    async function deleteUser(username) {
      myfetch('/auth-portal/user/' + username, 'DELETE', {}).then((res) => {
        if (!res.ok) {
          console.warn('fetch failed', res.status);
          return;
        }
        updateUserList();
      });
    }

    async function updateUserList() {
      const res = await fetch('/auth-portal/user');
      if (!res.ok) {
        console.warn('fetch failed', res.status);
        return;
      }
      const json = await res.json();
      if (!json.ok || (typeof json.data) != 'object') {
        console.warn('data failed', json);
        return;
      }
      document.querySelectorAll('#userlist_table .user').forEach(e => e.remove());
      const me = json.data.find(u => u.me);
      for (const user of json.data) {
        const tdName = document.createElement('td');
        const tdLevel = document.createElement('td');
        const tdActs = document.createElement('td');
        tdName.appendChild(document.createTextNode(user.username));
        tdLevel.appendChild(document.createTextNode(user.level));
        if (user.me)
          tdActs.appendChild(document.createTextNode('[you]'));
        else {
          const delbtn = document.createElement('input');
          delbtn.value = 'delete';
          delbtn.type = 'button';
          // delbtn.disabled = true;
          delbtn.addEventListener('click', () => { deleteUser(user.username); });
          tdActs.appendChild(delbtn);
        }
        const tr = document.createElement('tr');
        tr.classList.add('user');
        tr.append(tdName, tdLevel, tdActs);
        document.getElementById('userlist_table').append(tr);
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      updateUserList();
    });
  </script>
</body>

</html>